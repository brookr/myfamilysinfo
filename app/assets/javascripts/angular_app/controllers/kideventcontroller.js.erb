(function() {
  var app = angular.module('kid-events', ['event-directives']);

  app.controller('KidEventController', [ 'kidChangeHandler', '$http', '$scope', '$rootScope', function(kidChangeHandler, $http, $scope, $rootScope){
    $scope.events = [];
    $scope.event  = {};

    $scope.clearform = function() {
      $scope.event = {};
    };

    $rootScope.clearformdata = $scope.clearform;

    $scope.index = function() {
      $http.get('/api/v1/kids/' + $scope.kidlist.current_kid.id + '/events?auth_token=' + $rootScope.current_user.authentication_token)
        .success(function(data) {
          $scope.events = data;
          $scope.events.sort(function(a,b) {
            if(a.datetime > b.datetime) {
              return 1;
            }
            if(a.datetime < b.datetime) {
              return -1;
            }
            return 0;
          }).reverse();
        });
    };
    kidChangeHandler.add($scope.index);

    $scope.create = function(form, type) {
      $scope.event.type = type;
      $http.post('/api/v1/kids/' + $scope.kidlist.current_kid.id + '/events?auth_token=' + $rootScope.current_user.authentication_token, $scope.event)
        .success(function(data) {
          form.setForm(0);
          $scope.events.push(data);
          $scope.event = {};
          $scope.index();
        });
    };

    $scope.duplicate = function(event) {
      event.datetime = new Date();
      $http.post('/api/v1/kids/' + $scope.kidlist.current_kid.id + '/events?auth_token=' + $rootScope.current_user.authentication_token, event)
        .success(function(data) {
          $scope.events.push(data);
          $scope.index();
        });
    }

    $scope.edit = function(form, event) {
      $http.patch('/api/v1/kids/' + $scope.kidlist.current_kid.id + '/events/' + event.id + '?auth_token=' + $rootScope.current_user.authentication_token, event)
        .success(function(data) {
          form.setForm(0);
          $scope.index();
        });
    };

    $scope.delete = function(event) {
      $http.delete('/api/v1/kids/' + $scope.kidlist.current_kid.id + '/events/' + event.id + '?auth_token=' + $rootScope.current_user.authentication_token)
        .success(function(data) {
          if(confirm('Are you sure you want to delete this event?')) {
            var index = $scope.events.map(function(e) { return e.id; }).indexOf(event.id);
            $scope.events.splice(index, 1);
          };
        });
    };

  }]);

  app.controller('DropdownCtrl', function ($scope) {
    $scope.status = {
      isopen: false
    };

    $scope.toggleDropdown = function($event) {
      $event.preventDefault();
      $event.stopPropagation();
      $scope.status.isopen = !$scope.status.isopen;
    };

  });

  app.controller('DatepickerCtrl', function ($scope) {
    $scope.date = new Date();

    $scope.open = function($event) {
      $event.preventDefault();
      $event.stopPropagation();

      $scope.opened = true;
    };

  });

  app.controller('TimepickerCtrl', function ($scope, $log) {
    $scope.mytime = new Date();
  });

  app.controller('KidEditController', function ($scope){
    $scope.showform = false;
  });

})();
